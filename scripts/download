#!/usr/bin/env bash

show_help() {
  cat <<'EOF'
Usage:
  download <url> [- | FILE]

  download URL
  download URL FILE
  download URL -

Arguments:
  URL          Required. The URL to download.

  OUTPUT
    (omitted)  Save using the remote filename (curl -O / wget default)
    FILE       Save to the specified filename
    -          Write file to stdout

Examples:
  download https://example.com/file.tar.gz
  download https://example.com/file.tar.gz outfile.tar.gz
  download https://example.com/file.tar.gz -

Notes:
  - Uses tools in the following order: curl, wget, python3
  - curl uses: -f -s -S -L
  - wget uses: -q, and fails automatically on HTTP errors
EOF
}

available() {
  [[ -n $1 ]] && command -v -- "$1" >/dev/null 2>&1
}

error_no_tool_installed() {
  echo "Error: none of curl, wget or python3 are installed" >&2
  return 1
}

download_to_stdout() {
  local url=$1

  if available curl; then
    curl -fsSL "$url"
  elif available wget; then
    wget -qO- "$url"
  elif available python3; then
    python3 <<-EOF
			import sys, urllib.request

			url = "${url}"

			with urllib.request.urlopen(url) as r:
			    sys.stdout.buffer.write(r.read())
		EOF
  else
    error_no_tool_installed || return
  fi
}

download_to_remote_filename() {
  local url=$1

  if available curl; then
    curl -fsSLO "$url"
  elif available wget; then
    wget -q "$url"
  elif available python3; then
    python3 <<-EOF
			import os, urllib.request

			url = "${url}"
			filename = os.path.basename(url)

			urllib.request.urlretrieve(url, filename)
		EOF
  else
    error_no_tool_installed || return
  fi
}

download_to_custom_filename() {
  local url=$1
  local output=$2

  if available curl; then
    curl -fsSLo "$output" "$url"
  elif available wget; then
    wget -qO "$output" "$url"
  elif available python3; then
    python3 <<-EOF
			import urllib.request

			url = "${url}"
			out = "${output}"

			urllib.request.urlretrieve(url, out)
		EOF
  else
    error_no_tool_installed || return
  fi
}

download() {
  local url=$1
  local output=$2

  case "$url" in
  -h | --help | "")
    show_help
    return 0
    ;;
  esac

  case $output in
  -) download_to_stdout "$url" || return ;;
  "") download_to_remote_filename "$url" || return ;;
  *) download_to_custom_filename "$url" "$output" || return ;;
  esac
}

download "$@" || exit
